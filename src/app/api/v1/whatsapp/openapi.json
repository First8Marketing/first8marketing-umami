{
  "openapi": "3.0.3",
  "info": {
    "title": "WhatsApp Analytics Integration API",
    "description": "Comprehensive REST API for WhatsApp analytics integration with first8marketing-umami platform. Provides session management, messaging, conversations, contacts, analytics, correlations, notifications, and reporting.",
    "version": "1.0.0",
    "contact": {
      "name": "API Support",
      "email": "support@first8marketing.com"
    },
    "license": {
      "name": "MIT",
      "url": "https://opensource.org/licenses/MIT"
    }
  },
  "servers": [
    {
      "url": "https://api.first8marketing.com/api/v1/whatsapp",
      "description": "Production server"
    },
    {
      "url": "http://localhost:3000/api/v1/whatsapp",
      "description": "Development server"
    }
  ],
  "tags": [
    {
      "name": "Sessions",
      "description": "WhatsApp session management"
    },
    {
      "name": "Messages",
      "description": "Message operations"
    },
    {
      "name": "Conversations",
      "description": "Conversation management"
    },
    {
      "name": "Contacts",
      "description": "Contact management and synchronization"
    },
    {
      "name": "Analytics",
      "description": "Analytics and metrics"
    },
    {
      "name": "Correlations",
      "description": "User-phone correlation management"
    },
    {
      "name": "Notifications",
      "description": "Notification management"
    },
    {
      "name": "Reports",
      "description": "Report generation and export"
    }
  ],
  "security": [
    {
      "bearerAuth": []
    }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "JWT token obtained from authentication endpoint"
      }
    },
    "schemas": {
      "ApiResponse": {
        "type": "object",
        "required": ["success"],
        "properties": {
          "success": {
            "type": "boolean"
          },
          "data": {
            "type": "object",
            "description": "Response data (varies by endpoint)"
          },
          "error": {
            "type": "object",
            "properties": {
              "code": {
                "type": "string"
              },
              "message": {
                "type": "string"
              },
              "details": {
                "type": "object"
              }
            }
          },
          "meta": {
            "type": "object",
            "properties": {
              "timestamp": {
                "type": "string",
                "format": "date-time"
              },
              "pagination": {
                "$ref": "#/components/schemas/Pagination"
              }
            }
          }
        }
      },
      "Pagination": {
        "type": "object",
        "properties": {
          "total": {
            "type": "integer"
          },
          "limit": {
            "type": "integer"
          },
          "offset": {
            "type": "integer"
          },
          "hasMore": {
            "type": "boolean"
          }
        }
      },
      "Session": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "teamId": {
            "type": "string",
            "format": "uuid"
          },
          "phoneNumber": {
            "type": "string",
            "pattern": "^\\+[1-9]\\d{1,14}$"
          },
          "name": {
            "type": "string"
          },
          "status": {
            "type": "string",
            "enum": ["connecting", "connected", "disconnected", "error"]
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          },
          "updatedAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "Message": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "conversationId": {
            "type": "string",
            "format": "uuid"
          },
          "content": {
            "type": "string"
          },
          "direction": {
            "type": "string",
            "enum": ["inbound", "outbound"]
          },
          "status": {
            "type": "string",
            "enum": ["sent", "delivered", "read", "failed"]
          },
          "mediaUrl": {
            "type": "string",
            "format": "uri"
          },
          "mediaType": {
            "type": "string",
            "enum": ["image", "video", "audio", "document"]
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "Conversation": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "contactId": {
            "type": "string",
            "format": "uuid"
          },
          "status": {
            "type": "string",
            "enum": ["active", "resolved", "archived"]
          },
          "assignedTo": {
            "type": "string",
            "format": "uuid"
          },
          "tags": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "notes": {
            "type": "string"
          },
          "lastMessageAt": {
            "type": "string",
            "format": "date-time"
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "Contact": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "phoneNumber": {
            "type": "string"
          },
          "name": {
            "type": "string"
          },
          "email": {
            "type": "string",
            "format": "email"
          },
          "tags": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "customFields": {
            "type": "object"
          },
          "lastSeenAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "Correlation": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "userId": {
            "type": "string",
            "format": "uuid"
          },
          "phoneNumber": {
            "type": "string"
          },
          "confidence": {
            "type": "number",
            "minimum": 0,
            "maximum": 1
          },
          "status": {
            "type": "string",
            "enum": ["pending", "verified", "rejected"]
          },
          "verifiedAt": {
            "type": "string",
            "format": "date-time"
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "Notification": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "type": {
            "type": "string"
          },
          "title": {
            "type": "string"
          },
          "message": {
            "type": "string"
          },
          "read": {
            "type": "boolean"
          },
          "readAt": {
            "type": "string",
            "format": "date-time"
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "Report": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "reportType": {
            "type": "string",
            "enum": [
              "conversation_summary",
              "agent_performance",
              "conversion_analysis",
              "contact_engagement"
            ]
          },
          "status": {
            "type": "string",
            "enum": ["generating", "completed", "failed"]
          },
          "format": {
            "type": "string",
            "enum": ["json", "csv"]
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          },
          "completedAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "Error": {
        "type": "object",
        "required": ["success", "error"],
        "properties": {
          "success": {
            "type": "boolean",
            "example": false
          },
          "error": {
            "type": "object",
            "properties": {
              "code": {
                "type": "string",
                "example": "VALIDATION_ERROR"
              },
              "message": {
                "type": "string",
                "example": "Invalid input parameters"
              },
              "details": {
                "type": "object"
              }
            }
          },
          "meta": {
            "type": "object",
            "properties": {
              "timestamp": {
                "type": "string",
                "format": "date-time"
              }
            }
          }
        }
      }
    },
    "responses": {
      "Unauthorized": {
        "description": "Authentication required",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            },
            "example": {
              "success": false,
              "error": {
                "code": "AUTHENTICATION_ERROR",
                "message": "Authentication required"
              }
            }
          }
        }
      },
      "Forbidden": {
        "description": "Insufficient permissions",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            },
            "example": {
              "success": false,
              "error": {
                "code": "AUTHORIZATION_ERROR",
                "message": "Insufficient permissions"
              }
            }
          }
        }
      },
      "NotFound": {
        "description": "Resource not found",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            },
            "example": {
              "success": false,
              "error": {
                "code": "NOT_FOUND",
                "message": "Resource not found"
              }
            }
          }
        }
      },
      "RateLimitExceeded": {
        "description": "Rate limit exceeded",
        "headers": {
          "X-RateLimit-Limit": {
            "schema": {
              "type": "integer"
            },
            "description": "Rate limit per time window"
          },
          "X-RateLimit-Remaining": {
            "schema": {
              "type": "integer"
            },
            "description": "Remaining requests"
          },
          "X-RateLimit-Reset": {
            "schema": {
              "type": "string",
              "format": "date-time"
            },
            "description": "Time when rate limit resets"
          }
        },
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            },
            "example": {
              "success": false,
              "error": {
                "code": "RATE_LIMIT_EXCEEDED",
                "message": "Rate limit exceeded"
              }
            }
          }
        }
      }
    },
    "parameters": {
      "sessionId": {
        "name": "sessionId",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string",
          "format": "uuid"
        },
        "description": "Session UUID"
      },
      "messageId": {
        "name": "messageId",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string",
          "format": "uuid"
        },
        "description": "Message UUID"
      },
      "conversationId": {
        "name": "conversationId",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string",
          "format": "uuid"
        },
        "description": "Conversation UUID"
      },
      "contactId": {
        "name": "contactId",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string",
          "format": "uuid"
        },
        "description": "Contact UUID"
      },
      "correlationId": {
        "name": "correlationId",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string",
          "format": "uuid"
        },
        "description": "Correlation UUID"
      },
      "notificationId": {
        "name": "notificationId",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string",
          "format": "uuid"
        },
        "description": "Notification UUID"
      },
      "reportId": {
        "name": "reportId",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string",
          "format": "uuid"
        },
        "description": "Report UUID"
      },
      "limit": {
        "name": "limit",
        "in": "query",
        "schema": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "default": 50
        },
        "description": "Maximum number of results to return"
      },
      "offset": {
        "name": "offset",
        "in": "query",
        "schema": {
          "type": "integer",
          "minimum": 0,
          "default": 0
        },
        "description": "Number of results to skip"
      },
      "startDate": {
        "name": "startDate",
        "in": "query",
        "schema": {
          "type": "string",
          "format": "date-time"
        },
        "description": "Start date for filtering (ISO 8601)"
      },
      "endDate": {
        "name": "endDate",
        "in": "query",
        "schema": {
          "type": "string",
          "format": "date-time"
        },
        "description": "End date for filtering (ISO 8601)"
      }
    }
  },
  "paths": {
    "/sessions": {
      "get": {
        "tags": ["Sessions"],
        "summary": "List all sessions",
        "description": "Retrieve all WhatsApp sessions for the team",
        "operationId": "listSessions",
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "$ref": "#/components/parameters/limit" },
          { "$ref": "#/components/parameters/offset" }
        ],
        "responses": {
          "200": {
            "description": "Sessions retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    { "$ref": "#/components/schemas/ApiResponse" },
                    {
                      "type": "object",
                      "properties": {
                        "data": {
                          "type": "array",
                          "items": { "$ref": "#/components/schemas/Session" }
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "401": { "$ref": "#/components/responses/Unauthorized" },
          "429": { "$ref": "#/components/responses/RateLimitExceeded" }
        }
      },
      "post": {
        "tags": ["Sessions"],
        "summary": "Create new session",
        "description": "Create a new WhatsApp session and initiate QR authentication",
        "operationId": "createSession",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["phoneNumber"],
                "properties": {
                  "phoneNumber": {
                    "type": "string",
                    "pattern": "^\\+[1-9]\\d{1,14}$",
                    "example": "+1234567890"
                  },
                  "name": {
                    "type": "string",
                    "maxLength": 255,
                    "example": "Customer Support Line"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Session created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    { "$ref": "#/components/schemas/ApiResponse" },
                    {
                      "type": "object",
                      "properties": {
                        "data": { "$ref": "#/components/schemas/Session" }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Invalid input",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          },
          "401": { "$ref": "#/components/responses/Unauthorized" },
          "429": { "$ref": "#/components/responses/RateLimitExceeded" }
        }
      }
    },
    "/sessions/{sessionId}": {
      "get": {
        "tags": ["Sessions"],
        "summary": "Get session details",
        "operationId": "getSession",
        "security": [{ "bearerAuth": [] }],
        "parameters": [{ "$ref": "#/components/parameters/sessionId" }],
        "responses": {
          "200": {
            "description": "Session details retrieved",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    { "$ref": "#/components/schemas/ApiResponse" },
                    {
                      "type": "object",
                      "properties": {
                        "data": { "$ref": "#/components/schemas/Session" }
                      }
                    }
                  ]
                }
              }
            }
          },
          "401": { "$ref": "#/components/responses/Unauthorized" },
          "404": { "$ref": "#/components/responses/NotFound" }
        }
      },
      "delete": {
        "tags": ["Sessions"],
        "summary": "Terminate session",
        "operationId": "deleteSession",
        "security": [{ "bearerAuth": [] }],
        "parameters": [{ "$ref": "#/components/parameters/sessionId" }],
        "responses": {
          "200": {
            "description": "Session terminated successfully"
          },
          "401": { "$ref": "#/components/responses/Unauthorized" },
          "404": { "$ref": "#/components/responses/NotFound" }
        }
      }
    },
    "/messages": {
      "get": {
        "tags": ["Messages"],
        "summary": "List messages",
        "description": "List messages with optional filters",
        "operationId": "listMessages",
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "$ref": "#/components/parameters/limit" },
          { "$ref": "#/components/parameters/offset" },
          { "$ref": "#/components/parameters/startDate" },
          { "$ref": "#/components/parameters/endDate" },
          {
            "name": "conversationId",
            "in": "query",
            "schema": { "type": "string", "format": "uuid" }
          },
          {
            "name": "direction",
            "in": "query",
            "schema": { "type": "string", "enum": ["inbound", "outbound"] }
          },
          {
            "name": "status",
            "in": "query",
            "schema": { "type": "string", "enum": ["sent", "delivered", "read", "failed"] }
          }
        ],
        "responses": {
          "200": {
            "description": "Messages retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    { "$ref": "#/components/schemas/ApiResponse" },
                    {
                      "type": "object",
                      "properties": {
                        "data": {
                          "type": "array",
                          "items": { "$ref": "#/components/schemas/Message" }
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "401": { "$ref": "#/components/responses/Unauthorized" }
        }
      },
      "post": {
        "tags": ["Messages"],
        "summary": "Send message",
        "operationId": "sendMessage",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["conversationId", "content"],
                "properties": {
                  "conversationId": { "type": "string", "format": "uuid" },
                  "content": { "type": "string", "minLength": 1, "maxLength": 65536 },
                  "mediaUrl": { "type": "string", "format": "uri" },
                  "mediaType": { "type": "string", "enum": ["image", "video", "audio", "document"] }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Message sent successfully",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    { "$ref": "#/components/schemas/ApiResponse" },
                    {
                      "type": "object",
                      "properties": {
                        "data": { "$ref": "#/components/schemas/Message" }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": { "description": "Invalid input" },
          "401": { "$ref": "#/components/responses/Unauthorized" },
          "429": { "$ref": "#/components/responses/RateLimitExceeded" }
        }
      }
    },
    "/conversations": {
      "get": {
        "tags": ["Conversations"],
        "summary": "List conversations",
        "operationId": "listConversations",
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "$ref": "#/components/parameters/limit" },
          { "$ref": "#/components/parameters/offset" },
          { "$ref": "#/components/parameters/startDate" },
          { "$ref": "#/components/parameters/endDate" },
          {
            "name": "status",
            "in": "query",
            "schema": { "type": "string", "enum": ["active", "resolved", "archived"] }
          },
          {
            "name": "assignedTo",
            "in": "query",
            "schema": { "type": "string", "format": "uuid" }
          }
        ],
        "responses": {
          "200": {
            "description": "Conversations retrieved successfully"
          }
        }
      },
      "post": {
        "tags": ["Conversations"],
        "summary": "Create conversation",
        "operationId": "createConversation",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["contactId"],
                "properties": {
                  "contactId": { "type": "string", "format": "uuid" },
                  "phoneNumber": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "201": { "description": "Conversation created successfully" }
        }
      }
    },
    "/analytics/metrics": {
      "post": {
        "tags": ["Analytics"],
        "summary": "Calculate metrics",
        "operationId": "calculateMetrics",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["metrics"],
                "properties": {
                  "startDate": { "type": "string", "format": "date-time" },
                  "endDate": { "type": "string", "format": "date-time" },
                  "metrics": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "enum": [
                        "message_volume",
                        "response_time",
                        "resolution_rate",
                        "conversation_count",
                        "active_contacts"
                      ]
                    }
                  },
                  "groupBy": { "type": "string", "enum": ["day", "week", "month"] }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Metrics calculated successfully" }
        }
      }
    },
    "/correlations": {
      "get": {
        "tags": ["Correlations"],
        "summary": "List correlations",
        "operationId": "listCorrelations",
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "$ref": "#/components/parameters/limit" },
          { "$ref": "#/components/parameters/offset" },
          {
            "name": "status",
            "in": "query",
            "schema": { "type": "string", "enum": ["pending", "verified", "rejected"] }
          }
        ],
        "responses": {
          "200": { "description": "Correlations retrieved successfully" }
        }
      },
      "post": {
        "tags": ["Correlations"],
        "summary": "Trigger correlation",
        "operationId": "triggerCorrelation",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["phoneNumber"],
                "properties": {
                  "phoneNumber": { "type": "string" },
                  "userId": { "type": "string", "format": "uuid" },
                  "metadata": { "type": "object" }
                }
              }
            }
          }
        },
        "responses": {
          "201": { "description": "Correlation triggered successfully" }
        }
      }
    },
    "/notifications": {
      "get": {
        "tags": ["Notifications"],
        "summary": "List notifications",
        "operationId": "listNotifications",
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "$ref": "#/components/parameters/limit" },
          { "$ref": "#/components/parameters/offset" },
          {
            "name": "read",
            "in": "query",
            "schema": { "type": "boolean" }
          }
        ],
        "responses": {
          "200": { "description": "Notifications retrieved successfully" }
        }
      },
      "delete": {
        "tags": ["Notifications"],
        "summary": "Clear all notifications",
        "operationId": "clearAllNotifications",
        "security": [{ "bearerAuth": [] }],
        "responses": {
          "200": { "description": "All notifications cleared" }
        }
      }
    },
    "/reports": {
      "get": {
        "tags": ["Reports"],
        "summary": "List reports",
        "operationId": "listReports",
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "$ref": "#/components/parameters/limit" },
          { "$ref": "#/components/parameters/offset" }
        ],
        "responses": {
          "200": { "description": "Reports retrieved successfully" }
        }
      },
      "post": {
        "tags": ["Reports"],
        "summary": "Generate report",
        "operationId": "generateReport",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["reportType"],
                "properties": {
                  "reportType": {
                    "type": "string",
                    "enum": [
                      "conversation_summary",
                      "agent_performance",
                      "conversion_analysis",
                      "contact_engagement"
                    ]
                  },
                  "startDate": { "type": "string", "format": "date-time" },
                  "endDate": { "type": "string", "format": "date-time" },
                  "format": { "type": "string", "enum": ["json", "csv"], "default": "json" },
                  "filters": { "type": "object" }
                }
              }
            }
          }
        },
        "responses": {
          "201": { "description": "Report generation initiated" }
        }
      }
    }
  }
}
